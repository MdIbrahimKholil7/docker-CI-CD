name: CI/CD for Node App (Without Docker Compose)

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/node-app .
          docker push ${{ secrets.DOCKER_USERNAME }}/node-app

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to AWS EC2
        run: |
          echo "${{ secrets.AWS_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'REMOTE_EOF'

            set -e  # exit on any command failure

            # Create Docker network if not exists
            docker network create app_network || true

            # Stop and remove old MongoDB container
            docker stop mongodb || true
            docker rm mongodb || true

            # Run MongoDB
            docker run -d \
              --name mongodb \
              --network app_network \
              -v mongo_data:/data/db \
              -e MONGO_INITDB_ROOT_USERNAME=root \
              -e MONGO_INITDB_ROOT_PASSWORD=example \
              mongo:latest

            echo "Waiting for MongoDB to initialize..."
            sleep 30

            # Detect active color
            if docker ps --filter "name=node-app-blue" | grep -q node-app-blue; then
              ACTIVE_COLOR="blue"
              IDLE_COLOR="green"
              IDLE_PORT=3001
            elif docker ps --filter "name=node-app-green" | grep -q node-app-green; then
              ACTIVE_COLOR="green"
              IDLE_COLOR="blue"
              IDLE_PORT=3000
            else
              ACTIVE_COLOR="none"
              IDLE_COLOR="blue"
              IDLE_PORT=3000
            fi

            echo "Active Color: $ACTIVE_COLOR"
            echo "Deploying to: $IDLE_COLOR on port $IDLE_PORT"

            # Docker login
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # Stop and remove old idle container
            docker stop node-app-$IDLE_COLOR || true
            docker rm node-app-$IDLE_COLOR || true

            # Run new Node app container
            docker run -d \
              --name node-app-$IDLE_COLOR \
              --network app_network \
              -p $IDLE_PORT:3000 \
              ${{ secrets.DOCKER_USERNAME }}/node-app

            # Health check before switching traffic
            for i in {1..10}; do
              if curl -s http://localhost:$IDLE_PORT/health | grep OK > /dev/null; then
                echo "New container healthy!"
                break
              fi
              echo "Waiting for container health..."
              sleep 3
            done

            # Update NGINX upstream
            sudo sed -i "s|localhost:[0-9]*|localhost:$IDLE_PORT|g" /etc/nginx/conf.d/bluegreen.conf
            sudo nginx -s reload

            echo "Traffic switched to $IDLE_COLOR"

            # Optional: remove old active container
            if [ "$ACTIVE_COLOR" != "none" ]; then
              docker stop node-app-$ACTIVE_COLOR || true
              docker rm node-app-$ACTIVE_COLOR || true
              echo "Removed old $ACTIVE_COLOR container"
            fi

REMOTE_EOF
